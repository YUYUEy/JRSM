<!DOCTYPE html>
<html>

<head>
	<meta charset="utf-8">
	<title>四半期施策计划</title>
	<link rel="stylesheet" href="css/style.css">
	<link rel="stylesheet" type="text/css" href="css/iconfont.css"/>
	
</head>

<body>
<div class="all_content">
	<div class="nav">
		<h1 class="the_title">4-1. 四半期施策の画面イメージ説明(営業担当用)</h1>
		<p class="condition">
			对象年月
				<input type="text" placeholder="2017-10" id="start_month"/>
				~
				<input type="text" placeholder="2017-12" id="end_month"/>
				<button id="prev">&lt;&lt;前月</button>
				<button id="next">次月&gt;&gt;</button>
				<button>出退勤カレンダーへ</button>
				<button>日別活動進捗へ</button>
		</p>
		<div class="btnGroup2">
			<p>検索条件<a href="#" id="hide_condition">隠す</a></p>
			<table border="0" cellspacing="0" cellpadding="0">
				<tr>
					<td>支社</td>
					<td><select name="">
						<option value="">111</option>
						<option value="">222</option>
						<option value="">333</option>
					</select></td>
					<td>企業</td>
					<td><select name="">
						<option value="">111</option>
						<option value="">222</option>
						<option value="">333</option>
					</select></td>
				</tr>
				<tr>
					<td>グループ</td>
					<td><select name="">
						<option value="">111</option>
						<option value="">222</option>
						<option value="">333</option>
					</select></td>
					<td>店舗</td>
					<td><select name="">
						<option value="">111</option>
						<option value="">222</option>
						<option value="">333</option>
					</select></td>
					<td></td>
					<td><button class="jiansuo">检索</button></td>
				</tr>
			</table>
		</div>
		<div class="event_content">
			<div class="status">
				<div class="smallIcon">
					<span>提案</span><br />
					<span>
						<i class="icon iconfont icon-triangle-copy"></i>
						<i class="icon iconfont icon-triangle-copy"></i>
					</span>
				</div>
				<div class="smallIcon">
					<span>合意</span><br />
					<span>
						<i class="icon iconfont icon-yuanxing"></i>
						<i class="icon iconfont icon-yuanxing"></i>
					</span>
				</div>
				<div class="smallIcon">
					<span>实施</span><br />
					<span>
						<i class="icon iconfont icon-xingxing"></i>
						<i class="icon iconfont icon-xingxing"></i>
					</span>
				</div>
				<p>※青色は予定、ピンクは実績</p>
			</div>
			<div class="btnGroup3">
				<span class="sub_title">施策</span>
				
					<!--<div id="btn1" >
						<select id="xxx" >
							<option value="">勉強会1</option>
							<option value="">勉強会2</option>
							<option value="">勉強会3</option>
						</select>
					<input id="aaa" placeholder="qqq"/>
					</div>-->
					<select name="" id="btn1">
						<option value="">勉強会1</option>
						<option value="">勉強会2</option>
						<option value="">勉強会3</option>
					</select>
					<select name="" id="btn2">
						<option value="">提案1</option>
						<option value="">提案2</option>
						<option value="">提案3</option>
					</select>
					<select name="" id="btn3">
						<option value="">山積み1</option>
						<option value="">山積み2</option>
						<option value="">山積み3</option>
					</select>
					<select name="" id="btn4">
						<option value="">イベント1</option>
						<option value="">イベント2</option>
						<option value="">イベント3</option>
					</select>
					<select name="" id="btn5">
						<option value="">その他1</option>
						<option value="">その他2</option>
						<option value="">その他3</option>
					</select>
					<!--<button id="btn1">勉強会</button>
					<button id="btn2">提案</button>
					<button id="btn3">山積み</button>
					<button id="btn4">イベント</button>
					<button id="btn5">その他</button>-->
					<div class="innerBtn">
						プロセス管理
						<select>
							<option value="">店铺外活动1</option>
							<option value="">店铺外活动2</option>
							<option value="">店铺外活动3</option>
						</select>
					</div>
			</div>
		</div>
	</div>
	
	<div class="wraper" id="wrap">
		<!--<div class="tab">
			<table>
					<thead>
						<tr>
							<th>日</th>
							<th>一</th>
							<th>二</th>
							<th>三</th>
							<th>四</th>
							<th>五</th>
							<th>六</th>
						</tr>
					</thead>
					<tbody>						
					</tbody>				
			</table>
		</div> -->
	</div>
	<div class="bottom">
		<ul class="btnGroup">
			<li>複写元
				<select name="" id="">
					<option value="">A店</option>
					<option value="">B店</option>
					<option value="">C店</option>
					<option value="">D店</option>
					<option value="">E店</option>
				</select>
			</li>
			<li class="last_choose">複写先
				<select name="" id="">
					<option value="">A店</option>
					<option value="">B店</option>
					<option value="">C店</option>
					<option value="">D店</option>
					<option value="">E店</option>
				</select>
				（複数選択）
			</li>
			<li><button>複写登録</button></li>
			<li><button id="ykdl"><a target="_blank" href="ykdl.html">一括登録</a></button></li>
			<li><button>スケジュール削除</button></li>
			<li><button>印刷</button></li>
		</ul>
	</div>
	<ul>
		<li><button id="PrevPage">上一页</button><button id="nextPage">下一页</button> 第<input id="showPage" type="text" value="1" style="width: 20px;text-align: center;"/>页，共6页</li>
	</ul>
	<!-- 浮层框架开始 -->
	<div id="bg"></div>
	<div id="show">
		<div id="chooseTime">
			<button id="btnclose">关闭</button>
			<h2>施策計画入力画面</h2>
			<table id="chooseEvent">
				<tr>
					<td>店舗</td>
					<td>
						<select id="which_shop">
							<option value="">A店</option>
							<option value="">B店</option>
							<option value="">C店</option>
							<option value="">D店</option>
							<option value="">E店</option>
						</select>
					</td>
				</tr>
				<tr>
					<td>期間</td>
					<td>
						<input type="date" id="startTime"/><span id="bolang">~</span><input type="date" id="endTime"/>
					</td>
				</tr>
				<tr>
					<td></td>
					<td id="toast">时间输入有误！</td>
				</tr>
				<tr>
					<td>施策</td>
					<td>
						<select name="" id="which_type">
							<option value="施策">施策</option>
							<option value="プロセス管理">プロセス管理</option>
						</select>
					</td>
				</tr>
				
				<tr>
					<td>カテゴリ</td>
					<td>
						<select name="" id="eventType">
							<option value="#ff0000" id="the_first">勉強会</option>
							<option value="#ffcc00">提案</option>
							<option value="#00ff99">山積み</option>
							<option value="#00ccff">イベント</option>
							<option value="#00ffff">その他</option>
							<option value="#0f3" id="the_others">店舗外活動</option>
						</select>
						<!--<select name="" id="event_type">
							<option value="#0f3">店舗外活動</option>
						</select>-->
					</td>
				</tr>
				<tr>
					<td>内容</td>
					<td>
						<select >
							<option value="">111</option>
							<option value="">222</option>
						</select>
					</td>
				</tr>
				<tr>
					<td>商品</td>
					<td><input type="checkbox" id="すべて"/><label for="すべて">すべて</label></td>
				</tr>
				<tr>
					<td></td>
					<td>
						<input type="checkbox" id="pc"/><label for="pc">PC</label>
						<input type="checkbox" id="tv"/><label for="tv">TV</label>
						<input type="checkbox" id="ac"/><label for="ac">空调</label>
					</td>
				</tr>
				<tr>
					<td></td>
					<td>
						<input type="checkbox" id="dvd"/><label for="dvd">DVD</label>
						<input type="checkbox" id="fridge"/><label for="fridge">冰箱</label>
						<input type="checkbox" id="washer"/><label for="washer">洗衣机</label>
					</td>
				</tr>
			</table>
			<button id="btnSave">保存</button>
		</div>
	</div>
	<!-- 浮层框架结束-->
	<!--<div class="showEdit">
		<ul>
			<li>111</li>
			<li>222</li>
		</ul>
		<div class="editAndDel">
			<button class="toEdit">edit</button>
			<button class="toDel">del</button>
		</div>
	</div>-->
	<!--编辑和删除-->
	
</div>	

	<script type="text/javascript" src='js/jquery.js'></script>
	<script type="text/javascript" src='js/jquery.cookie.js'></script>
	<script type="text/javascript" src='js/data.js'></script>
	<script type="text/javascript" src='js/main.js'></script>

	<script type="text/javascript">

		var year = new Date().getFullYear(); 
		var month = new Date().getMonth() +1;
		var eventArr = $.cookie("eventInfo") ? JSON.parse($.cookie("eventInfo")) :[];
		/*$.get("eventArr2.json", function(data){
			eventArr = data;
			sort(eventArr)
			console.log(eventArr)
			initMonth()
		})*/
		//
		var shopList = 65;
		initMonth();	//初始化
		var disX;
		var disY;
		var startTime;
		var endTime;
		var showInfo = [];
		var firstDay;
		//
		$("#PrevPage").click(function(){
			shopList -=5;
			$("#showPage").val($("#showPage").val()-1)
			if(shopList <=65){
				shopList = 65;
				$("#showPage").val(1)
			};
			initMonth()
		});
		$("#nextPage").click(function(){
			shopList +=5;
			$("#showPage").val($("#showPage").val()-0+1)
			if(shopList >=86) {
				shopList = 86;
				$("#showPage").val(6)
			}
			initMonth()
		})
		function initMonth() {			
			year = mGetDate(year, month).split('-')[0];
			month = mGetDate(year, month).split('-')[1];
			$("#start_month").val( mGetDate(year, month) );
			$("#end_month").val( mGetDate(year, month -0+2) );
			$("#wrap").html(datepicker.buildUi(year, month, shopList));
			showThreeMonth();
		};
		function mGetDate(year, month){
			var yyy = new Date(year, month-1).getFullYear();
			var mmm = new Date(year, month-1).getMonth() +1 ;
			mmm = mmm <10 ?'0'+mmm :mmm;
			return yyy +'-'+mmm;
		};
		function format(date){	//输出格式化时间
			var rightMonth = (date.getMonth() +1) <10 ?'0'+(date.getMonth() +1) : (date.getMonth() +1);
			var rightDate = date.getDate() <10 ?'0'+date.getDate() :date.getDate();
			var ret = date.getFullYear() +'-'+ rightMonth +'-'+ rightDate;
			return ret;
		};
		function getWeek(year, month){
			var weekCount;
			var firstWeekday = new Date(year, month -1, 1).getDay();////获取一个月的一号是周几？
			var dayCount  = new Date(year, month, 0).getDate();//总天数
			if(firstWeekday ==0) firstWeekday =7;
			if(firstWeekday ==1){
				weekCount = Math.ceil(dayCount/7)
			}else{
				var lastDays = dayCount -(8- firstWeekday);
				weekCount = Math.ceil(lastDays/7);
			}
			return weekCount;			
		};
	
		function showThreeMonth(){
			var weekArr = [];
			var weekLength = 0;
			$(".threeMonth span").each(function(i){
				$(this).html(mGetDate(year, month -0 +i));
				var aaa = mGetDate(year, month -0 +i).split('-')[0];
				var bbb = mGetDate(year, month -0 +i).split('-')[1];
				weekLength += getWeek(aaa, bbb);
				for(var j=0; j< getWeek(aaa, bbb) ; j++){
					weekArr.push(j+1)
				}
				if(getWeek(aaa, bbb) ==5){
					$(this).parent().attr("colspan","35")
				}
			});
			if(weekLength - $(".fourteen span").length ==1){
				$(".fourteen").append( $('<th colspan="7"><span></span>w</th>') );
				$(".shopEvent").append( $('<td colspan="7"></td>') );
			}else if( $(".fourteen span").length - weekLength ==1){
				$(".fourteen").find(".lastW").remove();
				$(".shopEvent").find(".lastW").remove();
			}
			$(".fourteen span").each(function(k){
				$(this).html(weekArr[k])
			});
			$(".bor").width( 49 * weekLength -1 );
			firstDay = format( new Date(monthData[0].year, monthData[0].month - 1, $("#mainTd td")[1].dataset.date) );
			//渲染事件到页面上
			
			var heightArr =[];
			eventArr.forEach(function(val){
				var initLeft = parseInt((Date.parse( val.startTime )- Date.parse(firstDay))/(1000* 3600* 24)) *7 +'px';	//初始位置
				var initTop = getPosition( val.whichShop, val.startTime, val.endTime, heightArr );
				var spanInfo = [val.startTime, val.endTime, val.whichShop, val.eventType, val.str];
				var initWidth = parseInt((Date.parse( val.endTime )- Date.parse( val.startTime ))/(1000* 3600* 24)) *7 +'px';	//初始宽度
				if(initLeft && initTop){
					var span = $("<span class='showEvent' data-info='"+ spanInfo +"' data-id='"+ val.code +"'>"+ val.eventType + ':' + val.str +"</span>").appendTo($(".bor"));
					span.css({"top": initTop +'px', "left": initLeft }).css({'width': initWidth, "background": val.background});
				}
			})
			hideEdit()
		}
		
		$("#prev").click(function () {	//--
			month--;
			initMonth();
		});
		$("#next").click(function () {	//++
			month++;
			initMonth();
		});
		var fleet = true;
		var delObj;
		
		function getPosition(whichShop, xxx, yyy, heightArr){
			var sum = 0;
			disY = undefined;
			$(".context .shopEvent").each(function(){
				var eachTop = $(this).get(0).offsetTop - 60; // 每个tr相对context的高度；
				if($(this).find(".supplyHead").html() ==whichShop){
					disY = eachTop +10;
//					$(this).height(45);
					heightArr.forEach( val => {
						if( disY ==val.initTop ){
							if( (val.startTime <=xxx && xxx <=val.endTime) || (val.startTime <=yyy && yyy <=val.endTime) || (val.startTime >=xxx && yyy >=val.endTime) ){
								$(this).height($(this).height() + 30);	//自增30px
								disY += 30;
							}
						}
					})
				}
				sum += $(this).height();
			});
			$(".bor").height( sum -1);
			$("#his_name").height( sum -1 );
			heightArr.push({
				initTop: disY,
				startTime: xxx,
				endTime: yyy
			})
			return disY
		}
		//
		function sort(eventArr){
			for (var k=0; k<eventArr.length-1; k++) { //给请求的数据，根据开始时间来升序排序
				for (var m=0; m<eventArr.length-1-k; m++) {
					if ( (eventArr[m].startTime) > (eventArr[m+1].startTime) ) {
						var tmp =  eventArr[m] ;
						 eventArr[m]= eventArr[m+1];
						eventArr[m+1]= tmp;
					}
				}
			}
			for (var i=0; i<eventArr.length-1; i++) { //根据店铺来升序排序
				for (var j=0; j<eventArr.length-1-i; j++) {
					if ( (eventArr[j].whichShop).split("")[0] > (eventArr[j+1].whichShop).split("")[0] ) {
						var tmp =  eventArr[j] ;
						 eventArr[j]= eventArr[j+1];
						eventArr[j+1]= tmp;
					}
				}
			}
		}
		//
		var trigger;
		var bgColor;
		var selectedArr = [];
		var copyTrigger = true;
		document.addEventListener("click",function(e){
			if(e.target.className=="bor"){	//add
				trigger = false;
				showdiv();
				hideEdit()
			}else if(e.target.className =="showEvent"){	//弹出详细窗口
				showInfo = (e.target.dataset.info).split(',');
				disX = e.target.style.left;
				disY = e.target.style.top;
				bgColor = e.target.style.background;
				var spanWidth = parseInt((Date.parse(showInfo[1])- Date.parse(showInfo[0]))/(1000* 3600* 24)) *7;	//初始宽度
				var showLeft =( parseInt(disX) + spanWidth) <= 600 ?( parseInt(disX) + spanWidth) : (parseInt(disX) -300);
				var showTop = parseInt(disY) -60;
				window.editID = e.target.dataset.id;
				delObj = e.target;
				if(fleet){
					showEdit(showLeft, showTop)
				}else{
					hideEdit()
				}
			
			}else if(e.target.className =="toEdit"){	//跳转编辑
				trigger = true;
				showdiv();
				hideEdit();
			}else if(e.target.className =="toDel"){		//删除
				eventArr.forEach(function(val, index){
					if(val.code ==editID){
						eventArr.splice(index, 1);
						$.cookie("eventInfo", JSON.stringify(eventArr), {expires:30,path:"/"});
					}
				});
				delObj.remove();
				hideEdit();
				initMonth();
			}else if(e.target.className =="icon iconfont icon-xinzeng"){	//关闭当前窗口
				hideEdit();
			}else if(e.target.className =="copyCancel"){
				$(".the_copy").hide();
			}else if(e.target.className =="toCopy"){
				if(copyTrigger){
					$(".the_copy").show();
				}else {
					$(".the_copy").hide();
				}
				copyTrigger =!copyTrigger;
			}else if(e.target.className =="copySave"){
				console.log(showInfo)
				var toShop = $("#toShop option:selected").text();
				var code = Math.floor(Math.random()* 9000) +1000;
				eventArr.push({
					startTime: showInfo[0],
					endTime: showInfo[1],
					whichShop: toShop,
					eventType: showInfo[3],
					str: selectedArr,
					background: bgColor,
					code: code
				});
				sort(eventArr)
				$.cookie("eventInfo", JSON.stringify(eventArr), {expires:30,path:"/"});
				hideEdit();
				initMonth();
			}
		},false);
		//
		function showEdit(showLeft, showTop){
			$(".showEdit").fadeIn();
			$(".showEdit").css({"left":showLeft +'px', "top": showTop +'px'});
			fleet = false;
			copyTrigger = true;
			selectedArr = [];
			for(var i=4; i<showInfo.length; i++){
				selectedArr.push(showInfo[i]);
			}
			$(".showEdit .the_title").html('活动：' +showInfo[2]+';'+ showInfo[3]);
			$(".showEdit .the_time").html('时间：' +showInfo[0]+ '~' + showInfo[1]);
			$(".showEdit .the_event").html('商品：'+ selectedArr.join(","));
		}
		function hideEdit(){
			$(".showEdit").fadeOut();
			$(".the_copy").hide();
			showInfo = [];
			fleet = true;
		}
		//			
		$("#startTime").focusout(function(){	//disX
			startTime = $(this).val();	
			disX = parseInt((Date.parse(startTime)- Date.parse(firstDay))/(1000* 3600* 24)) * 7 +'px';
		});
		$("#which_type").change(function(){
			if($("#which_type").val() =='プロセス管理'){
				$("#eventType #the_others").attr("selected","selected")
				$("#eventType #the_others").show().siblings().hide()
			}else if($("#which_type").val() =='施策'){
				$("#eventType #the_others").hide().siblings().show()
			}
		})
	
		$("#btnSave").click(function () {	//save
			var eventType = $("#eventType option:selected").text();
			var spanBackground = $("#eventType").val();
			var which_shop = $("#which_shop option:selected").text();
			startTime = $("#startTime").val();
			endTime = $("#endTime").val();
			var spanWidth = parseInt((Date.parse(endTime)- Date.parse(startTime))/(1000* 3600* 24)) *7;	//事件条宽度
			var str=[];
			$("#chooseEvent input[type=checkbox]:checked").each(function(){
				str.push( $(this)[0].labels[0].innerHTML) ;
			});
			if( spanWidth <=0 || disX==undefined ){
				$("#toast").show();
			}else{
//				var spanInfo = [startTime, endTime, which_shop, eventType, str];
				var code = Math.floor(Math.random()* 9000) +1000;
				if(trigger){	//编辑以后新增
					eventArr.forEach(function(val, index){
						if(val.code ==editID){
							eventArr.splice(index, 1);
							$.cookie("eventInfo", JSON.stringify(eventArr), {expires:30,path:"/"});
						}
					});
				}
				eventArr.push({
					startTime: startTime,
					endTime: endTime,
					whichShop: which_shop,
					eventType: eventType,
					str: str,
					background: spanBackground,
					code: code
				});
				sort(eventArr)
				$.cookie("eventInfo", JSON.stringify(eventArr), {expires:30,path:"/"});
				hidediv();
				initMonth();
			}
//			console.log(eventArr)
		});
		$("#btnclose").click(function () {	//close
			hidediv()
		});
		function showdiv() {
			$("#bg").show();
			$("#show").show();
			$("html,body").css("overflow", "hidden");
			var itemArr=[];
			$("#chooseEvent input[type=checkbox]").each(function(){
				itemArr.push($(this)[0].labels[0].innerHTML);
			});
			$("#startTime").val( $("#prevMonth span").html()+ '-01' );
			$("#endTime").val( $("#prevMonth span").html()+ '-01' );
			$("#which_shop option").each(function(i){	//渲染店铺列表
				$(this).get(0).innerHTML = String.fromCharCode(shopList +i) +'店';
			});
			$("#which_shop option").each(function(){	//默认选中的店铺
				if(showInfo[2] == $(this).get(0).innerHTML ){
					 $(this).get(0).selected  =true;
				}
			});
			$("#eventType option").each(function(){		//默认选中的事件
				if(showInfo[3] == $(this).get(0).innerHTML ){
					 $(this).get(0).selected  =true;
				}
			});
			if(showInfo.length >1){
				$("#startTime").val(showInfo[0]);
				$("#endTime").val(showInfo[1]);
				showInfo.splice(0,4);
				showInfo.forEach(function(val){
					var index = itemArr.indexOf(val);
					$("#chooseEvent input[type=checkbox]")[index].checked =true;
				})
			}
		};
		function hidediv() {
			//clear
			$("#startTime").val('');
			$("#endTime").val('');
			disX= undefined;
			trigger = false;
			$("#chooseEvent input[type=checkbox]").each(function(){
				$(this)[0].checked = false;
			});
			$("#toast").hide();
			$("#bg").hide();
			$("#show").hide();
			$("html,body").css("overflow", "auto");
		};
		//
		var hideShow = true
		$("#hide_condition").click(function(){
			if(hideShow){
				$(".btnGroup2").height("26px")
			}else{
				$(".btnGroup2").height("100px")
			}
			hideShow = !hideShow
		})
	
	</script>
</body>

</html>